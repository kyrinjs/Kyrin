# Kyrin v0.0.4 - Middleware System

‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° **Middleware System** ‡πÅ‡∏ö‡∏ö Onion Model ‡∏û‡∏£‡πâ‡∏≠‡∏° Hooks ‡πÅ‡∏•‡∏∞ Guard Pattern

---

## üÜï ‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô v0.0.4

### Middleware (Onion Model)

- `use()` - ‡πÄ‡∏û‡∏¥‡πà‡∏° global middleware
- `onRequest()` - hook ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ handler
- `onResponse()` - hook ‡∏´‡∏•‡∏±‡∏á response
- `guard()` - group routes ‡∏î‡πâ‡∏ß‡∏¢ middleware
- `cors()` - Built-in CORS plugin

### Context Enhancement

- `c.store` - shared data ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á middleware
- `c.set.status` - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î response status
- `c.set.headers` - ‡∏Å‡∏≥‡∏´‡∏ô‡∏î response headers

---

## üì¶ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Middleware

### 1. Standard Middleware (`use`)

```typescript
import { Kyrin, cors } from "kyrin";

const app = new Kyrin();

// Built-in CORS plugin
app.use(cors({ origin: "*" }));

// Custom middleware (Onion Model)
app.use(async (c, next) => {
  const start = Date.now();
  await next(); // ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å handler/middleware ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
  console.log(`${c.method} ${c.path} (${Date.now() - start}ms)`);
});

// Chain ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
app.use(cors()).use(auth).use(timing);

app.get("/", () => ({ message: "Hello!" }));
app.listen(3000);
```

---

### 2. Hooks (`onRequest` / `onResponse`)

‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤ middleware - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `next()`

```typescript
// ‡∏Å‡πà‡∏≠‡∏ô request ‡πÄ‡∏Ç‡πâ‡∏≤ handler
app.onRequest((c) => {
  c.store.startTime = Date.now();
});

// ‡∏´‡∏•‡∏±‡∏á response ‡∏≠‡∏≠‡∏Å
app.onResponse((c) => {
  const ms = Date.now() - c.store.startTime;
  console.log(`${c.method} ${c.path} ‚Üí ${c.set.status} (${ms}ms)`);
});

// Auth check (return Response = ‡∏´‡∏¢‡∏∏‡∏î request)
app.onRequest((c) => {
  if (!c.header("Authorization")) {
    return c.json({ error: "Unauthorized" }, 401);
  }
});
```

---

### 3. Guard (Group Routes)

‡∏£‡∏ß‡∏° routes ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô middleware ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô

```typescript
const auth = async (c, next) => {
  if (!c.header("Authorization")) {
    return c.json({ error: "Unauthorized" }, 401);
  }
  await next();
};

// ‡∏ó‡∏∏‡∏Å route ‡πÉ‡∏ô guard ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô auth
app.guard(auth, (app) => {
  app.get("/admin", () => ({ page: "admin" }));
  app.get("/dashboard", () => ({ page: "dashboard" }));
  app.post("/settings", async (c) => {
    const body = await c.body();
    return { saved: true };
  });
});

// Route ‡∏ô‡∏≠‡∏Å guard ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á auth
app.get("/", () => "Public page");
app.get("/health", () => ({ status: "ok" }));
```

---

## üåê CORS Plugin

Cross-Origin Resource Sharing (CORS) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö API ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å domain ‡∏≠‡∏∑‡πà‡∏ô

### Basic Usage

```typescript
import { Kyrin, cors } from "kyrin";

const app = new Kyrin();
app.use(cors()); // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
```

### Default Values

| Option           | Default                                                | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢                 |
| ---------------- | ------------------------------------------------------ | ------------------------ |
| `origin`         | `"*"`                                                  | Allow ‡∏ó‡∏∏‡∏Å origin         |
| `methods`        | `["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"]` | HTTP methods ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï   |
| `allowedHeaders` | `["Content-Type", "Authorization"]`                    | Headers ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï        |
| `credentials`    | `false`                                                | ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï cookies/auth      |
| `maxAge`         | `86400`                                                | Preflight cache (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) |

### Options Reference

#### origin

```typescript
// Allow ‡∏ó‡∏∏‡∏Å origin (default)
cors({ origin: "*" });

// Single origin
cors({ origin: "https://example.com" });

// Multiple origins
cors({ origin: ["https://example.com", "https://app.example.com"] });

// Dynamic (function)
cors({ origin: (origin) => origin.endsWith(".example.com") });
```

#### methods

```typescript
// ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏≤‡∏á methods
cors({ methods: ["GET", "POST"] });

// ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏∏‡∏Å method (default)
cors({ methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"] });
```

#### allowedHeaders

```typescript
// ‡πÄ‡∏û‡∏¥‡πà‡∏° custom headers
cors({ allowedHeaders: ["Content-Type", "Authorization", "X-Custom-Header"] });
```

#### credentials

```typescript
// ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï cookies ‡πÅ‡∏•‡∏∞ Authorization header
cors({
  origin: "https://example.com", // ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ origin ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
  credentials: true,
});
```

#### maxAge

```typescript
// Cache preflight request 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
cors({ maxAge: 3600 });
```

### Common Scenarios

#### API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Frontend ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

```typescript
app.use(
  cors({
    origin: "https://myapp.com",
    credentials: true,
  })
);
```

#### API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ Frontend

```typescript
app.use(
  cors({
    origin: [
      "https://app.example.com",
      "https://admin.example.com",
      "http://localhost:3000", // dev
    ],
    credentials: true,
  })
);
```

#### Public API (allow ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô)

```typescript
app.use(cors()); // ‡πÉ‡∏ä‡πâ default
```

### ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

1. **credentials + wildcard origin ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ**

   ```typescript
   // ‚ùå ‡πÑ‡∏°‡πà work - browser ‡∏à‡∏∞ block
   cors({ origin: "*", credentials: true });

   // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏ origin ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
   cors({ origin: "https://example.com", credentials: true });
   ```

2. **Preflight requests (OPTIONS)**
   - Browser ‡∏à‡∏∞‡∏™‡πà‡∏á OPTIONS request ‡∏Å‡πà‡∏≠‡∏ô POST/PUT/DELETE
   - CORS plugin ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
   - Response ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 204 No Content

---

## üîß Context Store & Set

### Store (Share Data)

```typescript
// Middleware 1: ‡πÉ‡∏™‡πà data
app.use(async (c, next) => {
  c.store.user = { id: 1, name: "John" };
  c.store.requestId = crypto.randomUUID();
  await next();
});

// Handler: ‡∏î‡∏∂‡∏á data
app.get("/profile", (c) => ({
  user: c.store.user,
  requestId: c.store.requestId,
}));
```

### Set (Response Options)

```typescript
app.use(async (c, next) => {
  c.set.headers["X-Request-ID"] = crypto.randomUUID();
  c.set.status = 200;
  await next();
});

// Headers ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ô response ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
```

---

## üìä Execution Order

```
Request
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  onRequest hooks (sequential)   ‚îÇ
‚îÇ  ‚Üì                              ‚îÇ
‚îÇ  Middleware 1 (before next)     ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ   ‚îÇ Middleware 2 (before next)‚îÇ ‚îÇ
‚îÇ   ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ ‚îÇ
‚îÇ   ‚îÇ  ‚îÇ   Route Handler     ‚îÇ  ‚îÇ ‚îÇ
‚îÇ   ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚îÇ
‚îÇ   ‚îÇ Middleware 2 (after next) ‚îÇ ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ  Middleware 1 (after next)      ‚îÇ
‚îÇ  ‚Üì                              ‚îÇ
‚îÇ  onResponse hooks (sequential)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üì
Response
```

---

## ÔøΩ Middleware ‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå

### ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ

```
src/
‚îú‚îÄ‚îÄ index.ts              # Main app
‚îî‚îÄ‚îÄ middleware/
    ‚îú‚îÄ‚îÄ auth.ts           # Auth middleware
    ‚îî‚îÄ‚îÄ timing.ts         # Timing middleware
```

### 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Middleware (auth.ts)

```typescript
// src/middleware/auth.ts
import type { MiddlewareHandler } from "kyrin";

export const auth: MiddlewareHandler = async (c, next) => {
  const token = c.header("Authorization");

  if (!token) {
    return c.json({ error: "Unauthorized" }, 401);
  }

  c.store.user = { id: 1, name: "John" };
  await next();
};
```

### 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Middleware (timing.ts)

```typescript
// src/middleware/timing.ts
import type { MiddlewareHandler } from "kyrin";

export const timing: MiddlewareHandler = async (c, next) => {
  const start = Date.now();
  await next();
  console.log(`${c.method} ${c.path} (${Date.now() - start}ms)`);
};
```

### 3. ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Main App

```typescript
// src/index.ts
import { Kyrin, cors } from "kyrin";
import { auth } from "./middleware/auth";
import { timing } from "./middleware/timing";

const app = new Kyrin();

app.use(cors());
app.use(timing);

app.get("/", () => ({ message: "Hello!" }));

app.guard(auth, (app) => {
  app.get("/profile", (c) => ({ user: c.store.user }));
  app.get("/dashboard", () => ({ page: "dashboard" }));
});

app.listen(3000);
```

---

## ÔøΩüìã API Reference

| Method                 | ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢                     |
| ---------------------- | ---------------------------- |
| `app.use(middleware)`  | ‡πÄ‡∏û‡∏¥‡πà‡∏° global middleware      |
| `app.onRequest(hook)`  | hook ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ handler        |
| `app.onResponse(hook)` | hook ‡∏´‡∏•‡∏±‡∏á response           |
| `app.guard(mw, fn)`    | group routes ‡∏î‡πâ‡∏ß‡∏¢ middleware |
| `c.store`              | shared data object           |
| `c.set.status`         | response status code         |
| `c.set.headers`        | response headers             |
